version: 0.2

phases:
  install:
    commands:
      - echo "ğŸ“¦ Installing Newman..."
      - npm install -g newman newman-reporter-htmlextra
  build:
    commands:
      - echo "ğŸš€ Running API tests with Newman..."
      # cháº¡y newman, náº¿u fail thÃ¬ váº«n táº¡o report nhÆ°ng lÆ°u exit code
      - newman run Postman_Collections/colletionjson.json --reporters cli,htmlextra --reporter-htmlextra-export report.html
      - TEST_EXIT_CODE=$?
      - echo "âœ… Test completed. Uploading report to S3..."
      - aws s3 cp report.html s3://tiki-api-report-bucket/$(date +%F_%H-%M)-report.html
      - |
        if [ $TEST_EXIT_CODE -ne 0 ]; then
          echo "âŒ Test failed! Sending SNS alert..."
          aws sns publish --topic-arn arn:aws:sns:ap-southeast-1:110581573910:api-alert \
            --message "Tiki API test failed. Check report in S3."
        else
          echo "âœ… All tests passed!"
        fi

artifacts:
  files:
    - report.html


