version: 0.2

phases:
  install:
    commands:
      - echo "ğŸ“¦ Installing Newman..."
      - npm install -g newman newman-reporter-htmlextra
  build:
    commands:
      - echo "ğŸš€ Running API tests with Newman..."
      # cháº¡y newman, luÃ´n tráº£ vá» 0 Ä‘á»ƒ khÃ´ng dá»«ng build
      - newman run Postman_Collections/collection.json --reporters cli,htmlextra --reporter-htmlextra-export report.html || true
      - TEST_EXIT_CODE=${PIPESTATUS[0]}
      - echo "âœ… Test completed. Uploading report to S3..."
      - ls -l report.html || echo "âš ï¸ report.html not found"
      - aws s3 cp report.html s3://tiki-api-report-bucket/$(date +%F_%H-%M)-report.html --region ap-southeast-1
      - |
        if [ $TEST_EXIT_CODE -ne 0 ]; then
          echo "âŒ Test failed! Sending SNS alert..."
          aws sns publish --topic-arn arn:aws:sns:ap-southeast-1:110581573910:api-alert \
            --message "Tiki API test failed. Check report in S3."
        else
          echo "âœ… All tests passed!"
        fi

artifacts:
  files:
    - report.html
